# Инструкция по деплою на Render

## Подготовка

1. Зарегистрируйтесь на [Render](https://render.com/) и войдите в аккаунт.
2. Убедитесь, что ваш репозиторий доступен на GitHub.

## Шаг 1: Создание базы данных MongoDB

Для работы приложения нужна база данных MongoDB. Рекомендуется использовать MongoDB Atlas:

1. Зарегистрируйтесь на [MongoDB Atlas](https://www.mongodb.com/cloud/atlas/register).
2. Создайте новый кластер (бесплатный M0 подойдет для тестирования).
3. Настройте доступ:
   - Создайте пользователя базы данных с паролем.
   - Настройте IP доступ (можно разрешить доступ с любого IP: 0.0.0.0/0).
4. Получите строку подключения (Connection String).

## Шаг 2: Создание веб-сервиса на Render

1. В панели управления Render нажмите "New" и выберите "Web Service".
2. Подключите ваш GitHub репозиторий.
3. Настройте следующие параметры:
   - **Name**: `rabinskiy-sklad-api` (или любое другое имя)
   - **Root Directory**: `server` (важно указать директорию сервера)
   - **Environment**: `Node`
   - **Build Command**: `npm install && npm run build`
   - **Start Command**: `npm start`
   - **Plan**: Free (для тестирования)

## Шаг 3: Настройка переменных окружения

В разделе "Environment" добавьте следующие переменные:

```
NODE_ENV=production
PORT=10000
JWT_SECRET=ваш_секретный_ключ_jwt
JWT_EXPIRES_IN=24
MONGODB_URI=ваша_строка_подключения_mongodb
MOYSKLAD_LOGIN=demo
MOYSKLAD_PASSWORD=demo
MOYSKLAD_API_URL=https://api.moysklad.ru/api/remap/1.2
INIT_DB=true
```

**Важно**: 
- Замените `ваш_секретный_ключ_jwt` на случайную строку (минимум 32 символа).
- Замените `ваша_строка_подключения_mongodb` на строку подключения из MongoDB Atlas.
- После первого успешного деплоя измените `INIT_DB` на `false`, чтобы избежать повторной инициализации базы данных.

## Шаг 4: Настройка Health Check

В разделе "Health Check" укажите:
- **Path**: `/health`
- **Status**: 200

Это позволит Render мониторить состояние вашего приложения.

## Шаг 5: Деплой

1. Нажмите "Create Web Service" для создания сервиса.
2. Дождитесь завершения процесса сборки и деплоя.
3. После успешного деплоя ваше приложение будет доступно по URL вида `https://rabinskiy-sklad-api.onrender.com`.

## Проверка работоспособности

1. Откройте URL вашего сервиса в браузере.
2. Проверьте эндпоинт `/health` для проверки статуса сервера.
3. Проверьте эндпоинт `/health/db` для проверки подключения к базе данных.

## Доступ к API

После деплоя API будет доступен по следующим маршрутам:

- **Аутентификация**: `https://ваш-домен.onrender.com/api/auth/login`
- **Пользователи**: `https://ваш-домен.onrender.com/api/users`
- **Материалы**: `https://ваш-домен.onrender.com/api/materials`
- **Операции**: `https://ваш-домен.onrender.com/api/operations`
- **Заказы**: `https://ваш-домен.onrender.com/api/orders`
- **Учет времени**: `https://ваш-домен.onrender.com/api/worktime`
- **МойСклад**: `https://ваш-домен.onrender.com/api/moysklad`

## Учетные данные по умолчанию

После инициализации базы данных будет создан пользователь-администратор:
- **Логин**: `admin`
- **Пароль**: `admin123`

**Важно**: Смените пароль администратора после первого входа в систему.

## Решение проблем

### Проблема: Сервис не запускается

**Решение**:
- Проверьте логи в разделе "Logs" на Render.
- Убедитесь, что все переменные окружения настроены правильно.
- Проверьте подключение к MongoDB.

### Проблема: Ошибка подключения к MongoDB

**Решение**:
- Убедитесь, что строка подключения MONGODB_URI указана правильно.
- Проверьте, что IP адрес Render разрешен в настройках сетевого доступа MongoDB Atlas.
- Проверьте правильность учетных данных пользователя MongoDB. 