# Инструкция по деплою на Render

## Подготовка к деплою

### 1. Создание базы данных MongoDB Atlas

1. Зарегистрируйтесь или войдите в [MongoDB Atlas](https://www.mongodb.com/cloud/atlas)
2. Создайте новый кластер (можно использовать бесплатный M0 Sandbox)
3. Настройте сетевой доступ: добавьте IP-адрес `0.0.0.0/0` для доступа с любого IP (для продакшена лучше ограничить доступ)
4. Создайте пользователя базы данных с паролем
5. Получите строку подключения: нажмите "Connect" -> "Connect your application" и скопируйте URI

### 2. Подготовка проекта

Убедитесь, что в проекте есть следующие файлы:
- `Dockerfile` - для сборки контейнера
- `render.yaml` - для настройки деплоя на Render
- `server/.env.production` - шаблон переменных окружения для продакшена

## Деплой на Render

### 1. Создание нового веб-сервиса

1. Зарегистрируйтесь или войдите в [Render](https://render.com/)
2. Нажмите "New" -> "Web Service"
3. Подключите свой GitHub репозиторий
4. Выберите ветку для деплоя (обычно `main` или `master`)
5. Укажите имя сервиса, например, `rabinskiy-sklad-server`
6. Выберите тип "Docker"
7. Нажмите "Create Web Service"

### 2. Настройка переменных окружения

В панели управления сервисом на Render:
1. Перейдите в раздел "Environment"
2. Добавьте следующие переменные:
   - `MONGODB_URI` - строка подключения к MongoDB Atlas (замените `<username>`, `<password>` и `<cluster>` на ваши данные)
   - `JWT_SECRET` - секретный ключ для JWT (можно использовать автогенерацию)
   - `MOYSKLAD_LOGIN` - логин от МойСклад
   - `MOYSKLAD_PASSWORD` - пароль от МойСклад

### 3. Настройка автоматического деплоя

1. В разделе "Settings" убедитесь, что включена опция "Auto-Deploy"
2. При каждом пуше в выбранную ветку будет происходить автоматический деплой

## Проверка работоспособности

После успешного деплоя:
1. Откройте URL вашего сервиса на Render
2. Проверьте эндпоинт `/api/health` для проверки статуса сервера
3. Проверьте эндпоинт `/api/health/db` для проверки подключения к базе данных

## Решение проблем

### Проблема: Сервер не запускается

**Решение:**
- Проверьте логи в разделе "Logs" на Render
- Убедитесь, что все переменные окружения настроены правильно
- Проверьте подключение к MongoDB Atlas

### Проблема: Ошибка подключения к MongoDB

**Решение:**
- Убедитесь, что строка подключения MONGODB_URI указана правильно
- Проверьте, что IP-адрес Render добавлен в список разрешенных в MongoDB Atlas
- Проверьте правильность учетных данных пользователя MongoDB

### Проблема: Ошибка "No open ports detected"

**Решение:**
- Убедитесь, что сервер слушает порт, указанный в переменной окружения PORT
- Проверьте, что сервер запускается до подключения к MongoDB

## Полезные ссылки

- [Документация Render по веб-сервисам](https://render.com/docs/web-services)
- [Документация MongoDB Atlas](https://docs.atlas.mongodb.com/)
- [Документация МойСклад API](https://dev.moysklad.ru/doc/api/remap/1.2/) 